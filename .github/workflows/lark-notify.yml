name: Notify Lark on Event

on:
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get Commit Message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "COMMIT_MSG=${COMMIT_MSG}" >> $GITHUB_ENV
      
      - name: Send to Lark
        env:
          LARK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS="ğŸŸ¢ è¿›è¡Œä¸­"
          if [ "${{ github.event.pull_request.state }}" == "open" ]; then
            STATUS="ğŸŸ¢ è¿›è¡Œä¸­"
          else
            STATUS="ğŸ”´ å·²å…³é—­"
          fi
          PR_LINK="${{ github.event.pull_request.html_url }}"
          AUTHOR_NAME="${{ github.event.pull_request.user.login }}"

          MESSAGE=$(jq -n \
            --arg msg_type "text" \
            '{
                msg_type: $msg_type, 
                content: {
                  "card": {
                    "header": {
                      "title": {
                        "content": "ğŸ”” æ–° PR å¾…å®¡æŸ¥",
                        "tag": "plain_text"
                      }
                    },
                    "elements": [{
                      "tag": "div",
                      "text": {
                        "content": "ğŸ“Œ **æ ‡é¢˜**: ${{ env.COMMIT_MSG }}
                                  \nğŸš¥ **çŠ¶æ€**: $STATUS",
                                  \nğŸ”— **æäº¤é“¾æ¥**: $PR_LINK",
                                  \nğŸ‘¤ **æäº¤è€…**: @$AUTHOR_NAME",
                        "tag": "lark_md"
                      }
                    }, {
                      "actions": [{
                        "tag": "button",
                        "text": {
                                "content": "å‰å¾€å®¡æŸ¥",
                                "tag": "lark_md"
                        },
                        "url": $PR_LINK,
                        "type": "primary"
                      }],
                      "tag": "action"
                    }],
                  }
                }
              }')

          curl -sS -X POST "$LARK_URL" \
            -H "Content-Type: application/json" \
            -d "$MESSAGE"